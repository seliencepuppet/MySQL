
### MySQL自定义函数用法详解复合结构自定义变量/流程控制

<br/>

自定义函数(user-defined function UDF) 就是用一个象ABS() 或 CONCAT() 这样的固有(内建)函数一样作用的新函数去扩展MySQL.

所有UDF是对MySQL功能的一个扩展

创建自定义函数的语法:
```shell
创建UDF

create [aggregate] function `function_name`(parameter_name type, [parameter_name type, ...])
returns {string|integer|real}
runtime_body

简单的来看就是

create function `函数名称`(参数列表)
returns `返回值类型`
函数体
```

删除UDF

```shell
DROP FUNCTION `function_name`;
```

调用自定义函数的语法

```shell
select function_name(parameter_value, ...)
```

下面是为mysql创建自定义函数的几个小例子

```sql
create function `testfunction`()
RETURNS CHAR(50) DETERMINISTIC
RETURN CONCAT('hello', ' world');

select testfunction();

// 输出结果如下:
+----------------+
| testfunction() |
+----------------+
| hello world    |
+----------------+
```

UDF可以实现的功能不止于此, UDF有两个关键点，一个是参数，一个是返回值，UDF可以没有参数，但是UDF必须有且只有一个返回值在函数体中可以使用更为复杂的语法，比如复合结构/流程控制/任何SQL语句/定义变量等等。

#### 符合结构定义语法

在函数体中，如果包含多条语句可以放到BEGIN ... END 语句中

```sql
DELIMITER //
CREATE FUNCTION IF EXIST `deleteById`(uid UNSIGNED)
RETURNS VARCHAR(20)
BEGIN
    DELETE FROM som WHERE id = uid;
    RETURN (SELECT COUNT(id) FROM som);
END//
```

修改默认的结束符语法:
DELIMITER // 意思是修改默认的结束符 ";" 为 "//", 以后的SQL语句都要以 "//" 作为结尾

#### 自定义函数中局部变量语法

```shell
DECLARE var_name[,varname] 变量类型 [DEFAULT 默认值]
简单来说变量
DECLARE 变量1[变量2, ...] 变量类型 [DEFAULT 默认值]
```

这些变量的作用范围是在BEGIN...END程序中，而且定义局部变量语句必须在BEGIN...END的第一行定义

```sql
DELIMITER //
CREATE FUNTION `addTwoNumber`(x SMALLINT UNSIGNED, Y SMALLINT UNSIGNED)
RETURNS SMALLINT
BEGIN
    DECLARE a, b SMALLINT UNSIGNED DEFAULT 10;
    SET a = x, b = y;
    RETURN a + b;
END//
```

上面的代码只是把两个数进行想加, 意思是说明局部变量的用法.

```shell
为变量赋值语法:
SET parameter_name = value[, parameter_name = value...]
SELECT INTO parameter_name
```

例子

```sql
DECLARE x int;
SELECT COUNT(id) FROM tdb_name INTO x;
REUTRN X;
END//
```

用户变量定义语法(可以理解成全局变量)

```sql
SET @allParam = 100;
SELECT @allParam
```
